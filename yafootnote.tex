\directlua{dofile("./yafoot.lua")}

\documentclass[a4paper]{ltjsarticle}
\usepackage[no-math]{luatexja-fontspec}
\usepackage{luacode,luatexbase}
\usepackage[skins, breakable]{tcolorbox}
\usepackage{mdframed}
%\usepackage[callback={preout}]{nodetree}
\usepackage{lipsum}
\usepackage{bxjalipsum}

\setmainjfont[BoldFont=IPAexGothic]{IPAexMincho}
\setsansjfont{IPAexGothic}

\protected\def\pdfliteral{\pdfextension literal}

\makeatletter
\newdimen\my@tcb@ftn@height
\my@tcb@ftn@height\z@
\newcount\yafootnotecount
\newdimen\footnotewidth
\footnotewidth=\textwidth
\newdimen\paryafootnoteskip
\paryafootnoteskip=.1\baselineskip

\def\yafootnote#1{%
  \global\advance\yafootnotecount 1
  \global\expandafter\newbox
    \csname yafoot_\the\yafootnotecount\endcsname
  \global\expandafter\setbox
    \csname yafoot_\the\yafootnotecount\endcsname=
    \vtop{\hsize\footnotewidth\par\hbox{\vrule width0pt height4pt}
      \footnotesize\noindent *\the\yafootnotecount\, #1}%
  \bgroup
    \attribute100=\expandafter\the
      \csname yafoot_\the\yafootnotecount\endcsname
    \expandafter\yafootnotemark\expandafter{\the\yafootnotecount}
    \vadjust {\pdfliteral{}}%
  \egroup
}

\def\yafootnotemark#1{\small *\ensuremath{^{\mbox{#1}}}}

\directlua{%
    luatexbase.add_to_callback
      ("post_linebreak_filter",push_footnotes_below_lines,"pushftn")}

\directlua{%
    luatexbase.add_to_callback
      ("pre_output_filter",move_footnote_bottom,"moveftn")}

\directlua{%
    luatexbase.add_to_callback
      ("vpack_filter",crush_height_of_vlist,"crushvbox")}

\directlua{%
    luatexbase.add_to_callback
      ("buildpage_filter",page_ftn_height,"truncatepage")}

% from tcolorbox/tcbbreakable.code.tex
\def\tcb@vsplit@upper{%
  \tcbdimto\tcb@split@dim{\tcb@split@dim-\my@tcb@ftn@height}\global\my@tcb@ftn@height\z@
  \setbox\tcb@upperbox=\vsplit\tcb@totalupperbox to\tcb@split@dim%
  \edef\tcb@upper@box@badness{\the\badness}%
  }

% output
\def\my@tcb@output{%
  \ifdim\my@tcb@ftn@height>\z@
    \@tempdima\vsize
    \advance\@tempdima-\my@tcb@ftn@height
    \setbox\z@\vsplit\@cclv to \@tempdima%
    \setbox\tw@ =\vbox{\copy\@cclv}%
    \setbox\@cclv=\vbox{\copy\z@}%
    \global\my@tcb@ftn@height\z@
    \unvbox\tw@%
    \@makecol
    \@outputpage
    \setbox\z@\vbox{}
  \else
    \setbox\@cclv=\vbox{\unvbox\@cclv}%
    \@makecol
    \@outputpage
    \setbox\z@\vbox{}
  \fi}

\output{\my@tcb@output}

\makeatother

\begin{document}

\lipsum[1]

\begin{tcolorbox}[breakable]
あああ\\ bar\yafootnote{ねこねこ} foo \\ bar\yafootnote{fuga} \\ baz
\end{tcolorbox}

\jalipsum[1-5]{wagahai}

\begin{tcolorbox}[breakable]
あああ\\ bar\yafootnote{ねこねこ} \\ baz

\jalipsum[1-5]{wagahai}

foo \\ bar\yafootnote{fuga} \\ baz

\jalipsum[1-5]{wagahai}

foo \\ bar\yafootnote{fuga} \\ baz

\jalipsum[1-5]{wagahai}
\end{tcolorbox}

\end{document}

